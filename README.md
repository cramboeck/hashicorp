
ğŸ› ï¸ Azure Virtual Desktop Image Automation with Packer & Terraform

This repository provides a modular and production-ready framework to automatically build Azure Virtual Desktop (AVD) images using Packer and provision infrastructure using Terraform. The solution separates the base OS image (language packs, WinRM) from customized application images, enabling clean versioning via a Shared Image Gallery (SIG) and monthly rebuilds.


## ğŸ“ Project Structure

```bash



HASHICORP/
â”œâ”€â”€ 01-base-packer/                # Builds the base image with language packs
â”‚   â”œâ”€â”€ avd-base-image.pkr.hcl     # Packer template for base image
â”‚   â”œâ”€â”€ variables.pkr.hcl
â”‚   â”œâ”€â”€ terraform.auto.pkvars.json # Generated by Terraform
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ Enable-WinRM.ps1
â”‚       â””â”€â”€ install-WinLangPacks.ps1
â”‚
â”œâ”€â”€ 02-appscustom-packer/          # Builds app layer on top of base image
â”‚   â”œâ”€â”€ avd-image.pkr.hcl
â”‚   â”œâ”€â”€ variables.pkr.hcl
â”‚   â”œâ”€â”€ terraform.auto.pkvars.json
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ Enable-WinRM.ps1
â”‚       â”œâ”€â”€ Install-Software.ps1
â”‚       â”œâ”€â”€ Install-VDOT.ps1
â”‚       â”œâ”€â”€ Install-MSOFFICE365.ps1
â”‚       â”œâ”€â”€ Install_WindowsUpdates.ps1
â”‚       â””â”€â”€ optimize.ps1
â”‚
â”œâ”€â”€ avd-terraform/                 # Terraform for SIG and AVD infra
â”‚   â”œâ”€â”€ modules/                   # Modularized infrastructure components
â”‚   â”œâ”€â”€ main.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ locals.tf
â”‚   â”œâ”€â”€ outputs.tf
â”‚   â””â”€â”€ terraform.tfvars

```




## ğŸ”„ Workflow Overview
## 1ï¸âƒ£ Provision Shared Image Gallery (SIG) & Infrastructure

```cli
cd avd-terraform
terraform init
terraform apply -var-file="terraform.tfvars"
```
## Creates:

- Shared Image Gallery (SIG)
- Host pool, workspace, app group
- Outputs terraform.auto.pkvars.json for reuse in Packer

## 2ï¸âƒ£ Build Base Image

```cli
cd ../01-base-packer
packer init .
packer build avd-base-image.pkr.hcl
```
## This will:
- Use the marketplace AVD image as base
- Enable WinRM
- Install language packs
- Generalize the VM with Sysprep

Save the image to SIG as version yyyy.mm.dd-base

## 3ï¸âƒ£ Build Application Image
```cli
cd ../02-appscustom-packer
packer init .
packer build avd-image.pkr.hcl

```
## This will:
- Use the latest base image from SIG
- Install software (via Chocolatey or PADT)
- Optimize the image (VDOT, services, tasks)
- Apply Windows Updates
- Generalize and store the new image to SIG as version yyyy.mm.dd-apps

## ğŸ§° Key Features
   âœ… Separation of base and apps for faster monthly builds
   ğŸ” Secure variable handling via .auto.pkvars.json
   ğŸ§± Shared Image Gallery integration with versioning
   ğŸ“¦ PADT-ready for custom app deployments
   ğŸŒ Language pack provisioning with WinRM
   ğŸ§ª CMTrace-compatible logging
   ğŸ›¡ï¸ Terraform-based infrastructure provisioning

## ğŸ§© Next Steps
 - CI/CD Integration via GitHub Actions or Azure DevOps
 - Dynamic app selection and language installation
 - Image lifecycle automation & SIG cleanup
 - Role-based modular expansion (e.g., Office, dev tools, call centers)

## ğŸ‘¨â€ğŸ’» Maintained by
Christoph RambÃ¶ck
https://www.ramboeck-it.com
