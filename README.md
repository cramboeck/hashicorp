
🛠️ Azure Virtual Desktop Image Automation with Packer & Terraform

This repository provides a modular and production-ready framework to automatically build Azure Virtual Desktop (AVD) images using Packer and provision infrastructure using Terraform. The solution separates the base OS image (language packs, WinRM) from customized application images, enabling clean versioning via a Shared Image Gallery (SIG) and monthly rebuilds.


## 📁 Project Structure

```bash



HASHICORP/
├── 01-base-packer/                # Builds the base image with language packs
│   ├── avd-base-image.pkr.hcl     # Packer template for base image
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json # Generated by Terraform
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       └── install-WinLangPacks.ps1
│
├── 02-appscustom-packer/          # Builds app layer on top of base image
│   ├── avd-image.pkr.hcl
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       ├── Install-Software.ps1
│       ├── Install-VDOT.ps1
│       ├── Install-MSOFFICE365.ps1
│       ├── Install_WindowsUpdates.ps1
│       └── optimize.ps1
│
├── avd-terraform/                 # Terraform for SIG and AVD infra
│   ├── modules/                   # Modularized infrastructure components
│   ├── main.tf
│   ├── variables.tf
│   ├── locals.tf
│   ├── outputs.tf
│   └── terraform.tfvars



🚀 Getting Started

1. ✅ Prerequisites
Azure CLI

Terraform

Packer

A valid Azure subscription and Service Principal with the necessary rights

2. 📦 Build Infrastructure
bash
Copy
Edit
cd avd-terraform
terraform init
terraform plan -var-file="terraform.tfvars"
terraform apply -var-file="terraform.tfvars"
This will:

Create the AVD resource group, workspace, host pool, and application group

Create or update a Shared Image Gallery

Generate terraform.auto.pkvars.json for use in Packer

3. 🖼️ Build the Image
bash
Copy
Edit
cd ../packer
packer init .
packer build .
This will:

Use terraform.auto.pkvars.json to fetch credentials and image settings

Install apps using Chocolatey and PADT

Apply VDOT optimizations and Windows Updates

Create a versioned image in the Shared Image Gallery

🧰 Key Features
✅ Fully automated Terraform/Packer workflow

🔐 Secure variable handling via terraform.tfvars and secrets

🔄 Rebuildable and versioned SIG images for monthly rollouts

🌍 Multi-language support via language pack module (planned)

📦 PADT integration for consistent app deployments (e.g., Greenshot, Office)

📈 Logging with CMTrace formatting

📎 To-Do
 GitHub Actions or Azure DevOps CI/CD integration

 Dynamic multi-language installation

 Auto-cleanup and rollback on failure

 Enhanced modularity for reusable roles

💡 Credits
Created and maintained by Christoph Ramböck (Ramböck.IT)