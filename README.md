# ğŸ› ï¸ Azure AVD Image Builder & Terraform Automation
This repository provides a modular, production-grade automation framework for building and maintaining Azure Virtual Desktop (AVD) images using Packer and Terraform.

## It follows best practices such as:

- âœ¨ Modular infrastructure-as-code via Terraform
- ğŸ–¼ï¸ Multi-stage image builds using Packer
- ğŸ“¦ Clean app layer separation with PowerShell App Deployment Toolkit (PADT) & Chocolatey
- ğŸŒ Language Pack deployment and optimization
- ğŸ§ª CMTrace-compatible logging
- ğŸ” Monthly rebuilds with Shared Image Gallery versioning
- â˜ï¸ Optional integration with GitHub or Azure DevOps CI/CD


## ğŸ“ Project Structure

```bash

HASHICORP/
â”œâ”€â”€ 01-base-packer/                # Builds the base image with language packs
â”‚   â”œâ”€â”€ avd-base-image.pkr.hcl     # Packer template for base image
â”‚   â”œâ”€â”€ variables.pkr.hcl
â”‚   â”œâ”€â”€ terraform.auto.pkvars.json # Generated by Terraform
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ Enable-WinRM.ps1
â”‚       â””â”€â”€ install-WinLangPacks.ps1
â”‚
â”œâ”€â”€ 02-appscustom-packer/          # Builds app layer on top of base image
â”‚   â”œâ”€â”€ avd-image.pkr.hcl
â”‚   â”œâ”€â”€ variables.pkr.hcl
â”‚   â”œâ”€â”€ terraform.auto.pkvars.json
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ Enable-WinRM.ps1
â”‚       â”œâ”€â”€ Install-Software.ps1
â”‚       â”œâ”€â”€ Install-VDOT.ps1
â”‚       â”œâ”€â”€ Install-MSOFFICE365.ps1
â”‚       â”œâ”€â”€ Install_WindowsUpdates.ps1
â”‚       â””â”€â”€ optimize.ps1
â”‚
â”œâ”€â”€ 03-monthly-packer/            # Monthly rebuild using latest SIG version
â”‚   â”œâ”€â”€ avd-monthly.pkr.hcl        # Uses SIG as base, applies updates and republish
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ Enable-WinRM.ps1
â”‚       â”œâ”€â”€ Install-Software.ps1
â”‚       â”œâ”€â”€ Install-VDOT.ps1
â”‚       â”œâ”€â”€ Install-MSOFFICE365.ps1
â”‚       â”œâ”€â”€ Install_WindowsUpdates.ps1
â”‚       â””â”€â”€ optimize.ps1
|
â”œâ”€â”€ avd-terraform/                 # Terraform for SIG and AVD infra
â”‚   â”œâ”€â”€ modules/                   # Modularized infrastructure components
â”‚   â”œâ”€â”€ main.tf
â”‚   â”œâ”€â”€ variables.tf
â”‚   â”œâ”€â”€ locals.tf
â”‚   â”œâ”€â”€ outputs.tf
â”‚   â””â”€â”€ terraform.tfvars

```




# ğŸ”„ Workflow Overview
## 1ï¸âƒ£ Provision Shared Image Gallery (SIG) & Infrastructure

```cli
cd avd-terraform
terraform init
terraform apply -var-file="terraform.tfvars"
```
### Creates:

- Shared Image Gallery (SIG)
- Host pool, workspace, app group
- Outputs terraform.auto.pkvars.json for reuse in Packer

## 2ï¸âƒ£ Build Base Image

```cli
cd ../01-base-packer
packer init .
packer build avd-base-image.pkr.hcl
```
### This will:
- Use the marketplace AVD image as base
- Enable WinRM
- Install language packs
- Generalize the VM with Sysprep

Save the image to SIG as version yyyy.mm.dd-base

## 3ï¸âƒ£ Build Application Image
```cli
cd ../02-appscustom-packer
packer init .
packer build avd-image.pkr.hcl

```
### This will:
- Use the latest base image from SIG
- Install software (via Chocolatey or PADT)
- Optimize the image (VDOT, services, tasks)
- Apply Windows Updates
- Generalize and store the new image to SIG as version yyyy.mm.dd-apps

## 4ï¸âƒ£ Monthly Packer / Update Build
```cli
cd ../03-monthly-packer
packer init .
packer build avd-monthly.pkr.hcl

```
### This will:
- Uses latest SIG version as base image
- Applies Windows Updates, security patches, app updates
- Optionally runs cleanup or re-optimization
- Saves new version in SIG (e.g. 2025.06.01)


# ğŸ§° Key Features
 - âœ… Separation of base and apps for faster monthly builds
 - ğŸ” Secrets & credentials injected securely via .auto.pkvars.json
 - ğŸ§± Shared Image Gallery integration with versioning (e.g. sig_name/image_name/2025.05.21)
 - ğŸ“¦ PADT-ready for custom app deployments
 - ğŸŒ Language pack provisioning with WinRM
 - ğŸª› Easy debugging via packer-continue.txt
 - ğŸ§ª CMTrace-compatible logging
 - ğŸ›¡ï¸ Terraform-based infrastructure provisioning
 - âœ… Fully split Packer lifecycle (base â†’ app â†’ monthly)
  
# ğŸ§© Next Steps
 - CI/CD Integration via GitHub Actions or Azure DevOps
 - Dynamic app selection and language installation
 - Image lifecycle automation & SIG cleanup
 - Integration NeverRed 
 - Role-based modular expansion (e.g., Office, dev tools, call centers)

### ğŸ‘¨â€ğŸ’» Maintained by
Developed and maintained by Christoph RambÃ¶ck â€“ [Website](https://www.ramboeck-it.com)

Professional AVD infrastructure & automation consulting
