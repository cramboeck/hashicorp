# 🛠️ Azure AVD Image Builder & Terraform Automation

This repository contains a modular and professional automation framework for building **Azure Virtual Desktop (AVD)** images using **Packer** and provisioning infrastructure using **Terraform**. It includes best practices such as:

- Modular Terraform with shared image gallery
- Secure credential handling
- Packer provisioning with PowerShell and Chocolatey
- PADT (PowerShell App Deployment Toolkit) application packaging
- Language pack and Office installation
- CMTrace-compatible logging
- Optimized for reproducibility and monthly rebuilds

---

## 📁 Project Structure

```bash
hashicorp/
├── avd-terraform/             # Terraform infrastructure definition
│   ├── modules/               # Modularized components (workspace, SIG, etc.)
│   ├── main.tf                # Main module calls
│   ├── locals.tf              # Local variables (naming convention, tags, etc.)
│   ├── terraform.tfvars       # Environment-specific variables
│   ├── outputs.tf             # Exposed outputs
│   └── variables.tf           # Global variable definitions
│
├── packer/                    # Packer image builds
│   ├── scripts/               # PowerShell provisioning scripts
│   │   ├── Install-Software.ps1
│   │   ├── Install-VDOT.ps1
│   │   ├── Install-MSOFFICE365.ps1
│   │   ├── Install_WindowsUpdates.ps1
│   │   ├── Enable-WinRM.ps1
│   │   └── optimize.ps1
│   ├── PADT/                  # Application deployment packages (PADT-based)
│   ├── avd-image.pkr.hcl      # Main Packer build file
│   ├── variables.pkr.hcl      # Variable definitions
│   └── terraform.auto.pkvars.json  # Dynamically generated by Terraform

🚀 Getting Started

1. ✅ Prerequisites
Azure CLI

Terraform

Packer

A valid Azure subscription and Service Principal with the necessary rights

2. 📦 Build Infrastructure
bash
Copy
Edit
cd avd-terraform
terraform init
terraform plan -var-file="terraform.tfvars"
terraform apply -var-file="terraform.tfvars"
This will:

Create the AVD resource group, workspace, host pool, and application group

Create or update a Shared Image Gallery

Generate terraform.auto.pkvars.json for use in Packer

3. 🖼️ Build the Image
bash
Copy
Edit
cd ../packer
packer init .
packer build .
This will:

Use terraform.auto.pkvars.json to fetch credentials and image settings

Install apps using Chocolatey and PADT

Apply VDOT optimizations and Windows Updates

Create a versioned image in the Shared Image Gallery

🧰 Key Features
✅ Fully automated Terraform/Packer workflow

🔐 Secure variable handling via terraform.tfvars and secrets

🔄 Rebuildable and versioned SIG images for monthly rollouts

🌍 Multi-language support via language pack module (planned)

📦 PADT integration for consistent app deployments (e.g., Greenshot, Office)

📈 Logging with CMTrace formatting

📎 To-Do
 GitHub Actions or Azure DevOps CI/CD integration

 Dynamic multi-language installation

 Auto-cleanup and rollback on failure

 Enhanced modularity for reusable roles

💡 Credits
Created and maintained by Christoph Ramböck (Ramböck.IT)