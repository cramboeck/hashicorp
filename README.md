# ğŸ› ï¸ Azure AVD Image Builder & Terraform Automation

This repository contains a modular and professional automation framework for building **Azure Virtual Desktop (AVD)** images using **Packer** and provisioning infrastructure using **Terraform**. It includes best practices such as:

- Modular Terraform with shared image gallery
- Secure credential handling
- Packer provisioning with PowerShell and Chocolatey
- PADT (PowerShell App Deployment Toolkit) application packaging
- Language pack and Office installation
- CMTrace-compatible logging
- Optimized for reproducibility and monthly rebuilds

---

## ğŸ“ Project Structure

```bash
hashicorp/
â”œâ”€â”€ avd-terraform/             # Terraform infrastructure definition
â”‚   â”œâ”€â”€ modules/               # Modularized components (workspace, SIG, etc.)
â”‚   â”œâ”€â”€ main.tf                # Main module calls
â”‚   â”œâ”€â”€ locals.tf              # Local variables (naming convention, tags, etc.)
â”‚   â”œâ”€â”€ terraform.tfvars       # Environment-specific variables
â”‚   â”œâ”€â”€ outputs.tf             # Exposed outputs
â”‚   â””â”€â”€ variables.tf           # Global variable definitions
â”‚
â”œâ”€â”€ packer/                    # Packer image builds
â”‚   â”œâ”€â”€ scripts/               # PowerShell provisioning scripts
â”‚   â”‚   â”œâ”€â”€ Install-Software.ps1
â”‚   â”‚   â”œâ”€â”€ Install-VDOT.ps1
â”‚   â”‚   â”œâ”€â”€ Install-MSOFFICE365.ps1
â”‚   â”‚   â”œâ”€â”€ Install_WindowsUpdates.ps1
â”‚   â”‚   â”œâ”€â”€ Enable-WinRM.ps1
â”‚   â”‚   â””â”€â”€ optimize.ps1
â”‚   â”œâ”€â”€ PADT/                  # Application deployment packages (PADT-based)
â”‚   â”œâ”€â”€ avd-image.pkr.hcl      # Main Packer build file
â”‚   â”œâ”€â”€ variables.pkr.hcl      # Variable definitions
â”‚   â””â”€â”€ terraform.auto.pkvars.json  # Dynamically generated by Terraform

ğŸš€ Getting Started

1. âœ… Prerequisites
Azure CLI

Terraform

Packer

A valid Azure subscription and Service Principal with the necessary rights

2. ğŸ“¦ Build Infrastructure
bash
Copy
Edit
cd avd-terraform
terraform init
terraform plan -var-file="terraform.tfvars"
terraform apply -var-file="terraform.tfvars"
This will:

Create the AVD resource group, workspace, host pool, and application group

Create or update a Shared Image Gallery

Generate terraform.auto.pkvars.json for use in Packer

3. ğŸ–¼ï¸ Build the Image
bash
Copy
Edit
cd ../packer
packer init .
packer build .
This will:

Use terraform.auto.pkvars.json to fetch credentials and image settings

Install apps using Chocolatey and PADT

Apply VDOT optimizations and Windows Updates

Create a versioned image in the Shared Image Gallery

ğŸ§° Key Features
âœ… Fully automated Terraform/Packer workflow

ğŸ” Secure variable handling via terraform.tfvars and secrets

ğŸ”„ Rebuildable and versioned SIG images for monthly rollouts

ğŸŒ Multi-language support via language pack module (planned)

ğŸ“¦ PADT integration for consistent app deployments (e.g., Greenshot, Office)

ğŸ“ˆ Logging with CMTrace formatting

ğŸ“ To-Do
 GitHub Actions or Azure DevOps CI/CD integration

 Dynamic multi-language installation

 Auto-cleanup and rollback on failure

 Enhanced modularity for reusable roles

ğŸ’¡ Credits
Created and maintained by Christoph RambÃ¶ck (RambÃ¶ck.IT)