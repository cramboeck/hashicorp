
🛠️ Azure Virtual Desktop Image Automation with Packer & Terraform

This repository provides a modular and production-ready framework to automatically build Azure Virtual Desktop (AVD) images using Packer and provision infrastructure using Terraform. The solution separates the base OS image (language packs, WinRM) from customized application images, enabling clean versioning via a Shared Image Gallery (SIG) and monthly rebuilds.


## 📁 Project Structure

```bash



HASHICORP/
├── 01-base-packer/                # Builds the base image with language packs
│   ├── avd-base-image.pkr.hcl     # Packer template for base image
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json # Generated by Terraform
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       └── install-WinLangPacks.ps1
│
├── 02-appscustom-packer/          # Builds app layer on top of base image
│   ├── avd-image.pkr.hcl
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       ├── Install-Software.ps1
│       ├── Install-VDOT.ps1
│       ├── Install-MSOFFICE365.ps1
│       ├── Install_WindowsUpdates.ps1
│       └── optimize.ps1
│
├── avd-terraform/                 # Terraform for SIG and AVD infra
│   ├── modules/                   # Modularized infrastructure components
│   ├── main.tf
│   ├── variables.tf
│   ├── locals.tf
│   ├── outputs.tf
│   └── terraform.tfvars

```




## 🔄 Workflow Overview
## 1️⃣ Provision Shared Image Gallery (SIG) & Infrastructure

```cli
cd avd-terraform
terraform init
terraform apply -var-file="terraform.tfvars"
```
## Creates:

- Shared Image Gallery (SIG)
- Host pool, workspace, app group
- Outputs terraform.auto.pkvars.json for reuse in Packer

## 2️⃣ Build Base Image

```cli
cd ../01-base-packer
packer init .
packer build avd-base-image.pkr.hcl
```
## This will:
- Use the marketplace AVD image as base
- Enable WinRM
- Install language packs
- Generalize the VM with Sysprep

Save the image to SIG as version yyyy.mm.dd-base

## 3️⃣ Build Application Image
```cli
cd ../02-appscustom-packer
packer init .
packer build avd-image.pkr.hcl

```
## This will:
- Use the latest base image from SIG
- Install software (via Chocolatey or PADT)
- Optimize the image (VDOT, services, tasks)
- Apply Windows Updates
- Generalize and store the new image to SIG as version yyyy.mm.dd-apps

## 🧰 Key Features
   ✅ Separation of base and apps for faster monthly builds
   🔐 Secure variable handling via .auto.pkvars.json
   🧱 Shared Image Gallery integration with versioning
   📦 PADT-ready for custom app deployments
   🌍 Language pack provisioning with WinRM
   🧪 CMTrace-compatible logging
   🛡️ Terraform-based infrastructure provisioning

## 🧩 Next Steps
 - CI/CD Integration via GitHub Actions or Azure DevOps
 - Dynamic app selection and language installation
 - Image lifecycle automation & SIG cleanup
 - Role-based modular expansion (e.g., Office, dev tools, call centers)

## 👨‍💻 Maintained by
Christoph Ramböck
https://www.ramboeck-it.com
