# 🛠️ Azure AVD Image Builder & Terraform Automation
This repository provides a modular, production-grade automation framework for building and maintaining Azure Virtual Desktop (AVD) images using Packer and Terraform.

## 🚀 Quick Start

Verwenden Sie das **automatisierte Update-Script** für eine einfache Image-Verwaltung:

**Linux/macOS:**
```bash
./update-avd-image.sh
```

**Windows (PowerShell):**
```powershell
.\update-avd-image.ps1
```

Das Script bietet ein interaktives Menü für:
- ✅ Monatliche Updates (schnellste Option)
- 🔧 App-Layer Rebuilds
- 🔄 Vollständige Image-Rebuilds
- ☁️ Terraform Infrastruktur-Updates

## It follows best practices such as:

- ✨ Modular infrastructure-as-code via Terraform
- 🖼️ Multi-stage image builds using Packer
- 📦 Clean app layer separation with PowerShell App Deployment Toolkit (PADT) & Chocolatey
- 🌍 Language Pack deployment and optimization
- 🧪 CMTrace-compatible logging
- 🔁 Monthly rebuilds with Shared Image Gallery versioning
- ☁️ Optional integration with GitHub or Azure DevOps CI/CD


## 📁 Project Structure

```bash

HASHICORP/
├── 01-base-packer/                # Builds the base image with language packs
│   ├── avd-base-image.pkr.hcl     # Packer template for base image
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json # Generated by Terraform
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       └── install-WinLangPacks.ps1
│
├── 02-appscustom-packer/          # Builds app layer on top of base image
│   ├── avd-image.pkr.hcl
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       ├── Install-Software.ps1
│       ├── Install-VDOT.ps1
│       ├── Install-MSOFFICE365.ps1
│       ├── Install_WindowsUpdates.ps1
│       └── optimize.ps1
│
├── 03-monthly-packer/            # Monthly rebuild using latest SIG version
│   ├── avd-monthly.pkr.hcl        # Uses SIG as base, applies updates and republish
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       ├── Install-Software.ps1
│       ├── Install-VDOT.ps1
│       ├── Install-MSOFFICE365.ps1
│       ├── Install_WindowsUpdates.ps1
│       └── optimize.ps1
|
├── avd-terraform/                 # Terraform for SIG and AVD infra
│   ├── modules/                   # Modularized infrastructure components
│   ├── main.tf
│   ├── variables.tf
│   ├── locals.tf
│   ├── outputs.tf
│   └── terraform.tfvars

```




# 🔄 Workflow Overview
## 1️⃣ Provision Shared Image Gallery (SIG) & Infrastructure

```cli
cd avd-terraform
terraform init
terraform apply -var-file="terraform.tfvars"
```
### Creates:

- Shared Image Gallery (SIG)
- Host pool, workspace, app group
- Outputs terraform.auto.pkvars.json for reuse in Packer

## 2️⃣ Build Base Image

```cli
cd ../01-base-packer
packer init .
packer build avd-base-image.pkr.hcl
```
### This will:
- Use the marketplace AVD image as base
- Enable WinRM
- Install language packs
- Generalize the VM with Sysprep

Save the image to SIG as version yyyy.mm.dd-base

## 3️⃣ Build Application Image
```cli
cd ../02-appscustom-packer
packer init .
packer build avd-image.pkr.hcl

```
### This will:
- Use the latest base image from SIG
- Install software (via Chocolatey or PADT)
- Optimize the image (VDOT, services, tasks)
- Apply Windows Updates
- Generalize and store the new image to SIG as version yyyy.mm.dd-apps

## 4️⃣ Monthly Packer / Update Build
```cli
cd ../03-monthly-packer
packer init .
packer build avd-monthly.pkr.hcl

```
### This will:
- Uses latest SIG version as base image
- Applies Windows Updates, security patches, app updates
- Optionally runs cleanup or re-optimization
- Saves new version in SIG (e.g. 2025.06.01)


# 🧰 Key Features
 - ✅ Separation of base and apps for faster monthly builds
 - 🔐 Secrets & credentials injected securely via .auto.pkvars.json
 - 🧱 Shared Image Gallery integration with versioning (e.g. sig_name/image_name/2025.05.21)
 - 📦 PADT-ready for custom app deployments
 - 🌍 Language pack provisioning with WinRM
 - 🪛 Easy debugging via packer-continue.txt
 - 🧪 CMTrace-compatible logging
 - 🛡️ Terraform-based infrastructure provisioning
 - ✅ Fully split Packer lifecycle (base → app → monthly)
  
# 🧩 Next Steps
 - CI/CD Integration via GitHub Actions or Azure DevOps
 - Dynamic app selection and language installation
 - Image lifecycle automation & SIG cleanup
 - Integration NeverRed
 - Role-based modular expansion (e.g., Office, dev tools, call centers)

---

## 📝 Prerequisites

Bevor Sie beginnen, stellen Sie sicher, dass folgende Tools installiert sind:

- **Terraform** >= 1.9.0 ([Download](https://www.terraform.io/downloads))
- **Packer** >= 2.3.3 ([Download](https://www.packer.io/downloads))
- **Azure CLI** ([Download](https://docs.microsoft.com/cli/azure/install-azure-cli))
- **Git** (für Version Control)

### Azure Service Principal erstellen

```bash
az ad sp create-for-rbac --name "avd-terraform-sp" \
  --role Contributor \
  --scopes /subscriptions/{your-subscription-id}
```

Notieren Sie: `clientId`, `clientSecret`, `tenantId`

---

## ⚙️ Konfiguration

1. Kopieren Sie die Beispiel-Konfiguration:
   ```bash
   cd 00-avd-terraform
   cp terraform.tfvars.example terraform.tfvars
   ```

2. Bearbeiten Sie `terraform.tfvars` mit Ihren Azure-Credentials

3. Für Produktivumgebungen: Verwenden Sie Azure Key Vault oder Azure DevOps Variable Groups

---

## 🔐 Sicherheitshinweise

- ✅ WinRM über HTTP ist nur für temporäre Packer-Build-VMs akzeptabel
- ✅ Secrets werden über Azure Key Vault oder terraform.tfvars verwaltet
- ✅ terraform.tfvars wird von .gitignore ausgeschlossen
- ✅ Trusted Launch mit Secure Boot und vTPM aktiviert
- ✅ Debug-Mode ist standardmäßig deaktiviert

---

## 📦 Was ist neu?

### Version 2.0 - Januar 2025

- 🎯 **Automatisiertes Update-Script** (Bash & PowerShell) für einfache Image-Verwaltung
- 🔧 **Terraform Version Management** (.terraform-version)
- 📝 **terraform.tfvars.example** für einfachen Einstieg
- 🛡️ **Verbesserte Sicherheits-Dokumentation** für WinRM
- 🐛 **Bug-Fix**: Image-Version verwendet jetzt korrektes Datumsformat
- 🔄 **Optimierte Provider Constraints** (ermöglicht Patch-Updates)
- 🎨 **Erweiterte .gitignore** im Root-Verzeichnis
- ⚙️ **Parametrisierter Debug-Mode** in PowerShell Scripts
- 📜 **MIT License** hinzugefügt

---

## 📚 Dokumentation

- **README.md** - Diese Datei
- **terraform.tfvars.example** - Konfigurationsbeispiel
- **LICENSE** - MIT Lizenz

### Module-Dokumentation

Alle Terraform-Module befinden sich in `00-avd-terraform/modules/`:
- `resource_group` - Azure Resource Group Verwaltung
- `hostpool` - AVD Host Pool mit Scheduled Agent Updates
- `application_group` - Desktop Application Group
- `workspace` - AVD Workspace
- `shared_image_gallery` - Shared Image Gallery für Golden Images
- `avd_workspace_binding` - Workspace <-> Application Group Binding
- `storageaccount` - Storage Account für FSLogix Profile
- `domain_join` - Domain Join Konfiguration

---

### 👨‍💻 Maintained by
Developed and maintained by Christoph Ramböck – [Website](https://www.ramboeck-it.com)

Professional AVD infrastructure & automation consulting

---

## 📄 License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
