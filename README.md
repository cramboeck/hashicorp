# 🛠️ Azure AVD Image Builder & Terraform Automation
This repository provides a modular, production-grade automation framework for building and maintaining Azure Virtual Desktop (AVD) images using Packer and Terraform.

## It follows best practices such as:

- ✨ Modular infrastructure-as-code via Terraform
- 🖼️ Multi-stage image builds using Packer
- 📦 Clean app layer separation with PowerShell App Deployment Toolkit (PADT) & Chocolatey
- 🌍 Language Pack deployment and optimization
- 🧪 CMTrace-compatible logging
- 🔁 Monthly rebuilds with Shared Image Gallery versioning
- ☁️ Optional integration with GitHub or Azure DevOps CI/CD


## 📁 Project Structure

```bash

HASHICORP/
├── 01-base-packer/                # Builds the base image with language packs
│   ├── avd-base-image.pkr.hcl     # Packer template for base image
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json # Generated by Terraform
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       └── install-WinLangPacks.ps1
│
├── 02-appscustom-packer/          # Builds app layer on top of base image
│   ├── avd-image.pkr.hcl
│   ├── variables.pkr.hcl
│   ├── terraform.auto.pkvars.json
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       ├── Install-Software.ps1
│       ├── Install-VDOT.ps1
│       ├── Install-MSOFFICE365.ps1
│       ├── Install_WindowsUpdates.ps1
│       └── optimize.ps1
│
├── 03-monthly-packer/            # Monthly rebuild using latest SIG version
│   ├── avd-monthly.pkr.hcl        # Uses SIG as base, applies updates and republish
│   └── scripts/
│       ├── Enable-WinRM.ps1
│       ├── Install-Software.ps1
│       ├── Install-VDOT.ps1
│       ├── Install-MSOFFICE365.ps1
│       ├── Install_WindowsUpdates.ps1
│       └── optimize.ps1
|
├── avd-terraform/                 # Terraform for SIG and AVD infra
│   ├── modules/                   # Modularized infrastructure components
│   ├── main.tf
│   ├── variables.tf
│   ├── locals.tf
│   ├── outputs.tf
│   └── terraform.tfvars

```




# 🔄 Workflow Overview
## 1️⃣ Provision Shared Image Gallery (SIG) & Infrastructure

```cli
cd avd-terraform
terraform init
terraform apply -var-file="terraform.tfvars"
```
### Creates:

- Shared Image Gallery (SIG)
- Host pool, workspace, app group
- Outputs terraform.auto.pkvars.json for reuse in Packer

## 2️⃣ Build Base Image

```cli
cd ../01-base-packer
packer init .
packer build avd-base-image.pkr.hcl
```
### This will:
- Use the marketplace AVD image as base
- Enable WinRM
- Install language packs
- Generalize the VM with Sysprep

Save the image to SIG as version yyyy.mm.dd-base

## 3️⃣ Build Application Image
```cli
cd ../02-appscustom-packer
packer init .
packer build avd-image.pkr.hcl

```
### This will:
- Use the latest base image from SIG
- Install software (via Chocolatey or PADT)
- Optimize the image (VDOT, services, tasks)
- Apply Windows Updates
- Generalize and store the new image to SIG as version yyyy.mm.dd-apps

## 4️⃣ Monthly Packer / Update Build
```cli
cd ../03-monthly-packer
packer init .
packer build avd-monthly.pkr.hcl

```
### This will:
- Uses latest SIG version as base image
- Applies Windows Updates, security patches, app updates
- Optionally runs cleanup or re-optimization
- Saves new version in SIG (e.g. 2025.06.01)


# 🧰 Key Features
 - ✅ Separation of base and apps for faster monthly builds
 - 🔐 Secrets & credentials injected securely via .auto.pkvars.json
 - 🧱 Shared Image Gallery integration with versioning (e.g. sig_name/image_name/2025.05.21)
 - 📦 PADT-ready for custom app deployments
 - 🌍 Language pack provisioning with WinRM
 - 🪛 Easy debugging via packer-continue.txt
 - 🧪 CMTrace-compatible logging
 - 🛡️ Terraform-based infrastructure provisioning
 - ✅ Fully split Packer lifecycle (base → app → monthly)
  
# 🧩 Next Steps
 - CI/CD Integration via GitHub Actions or Azure DevOps
 - Dynamic app selection and language installation
 - Image lifecycle automation & SIG cleanup
 - Integration NeverRed 
 - Role-based modular expansion (e.g., Office, dev tools, call centers)

### 👨‍💻 Maintained by
Developed and maintained by Christoph Ramböck – [Website](https://www.ramboeck-it.com)

Professional AVD infrastructure & automation consulting
